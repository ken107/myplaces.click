<!DOCTYPE html>
<html lang="zxx">
<head>
    <title>COVID-19 Testing Locations</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <!-- External CSS libraries -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-submenu.css">

    <link rel="stylesheet" type="text/css" href="css/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="css/daterangepicker.css">
    <link rel="stylesheet" href="css/map.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" type="text/css"  href="css/jquery.mCustomScrollbar.css">
    <link rel="stylesheet" type="text/css"  href="css/components.css">

    <!-- Custom stylesheet -->
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" id="style_sheet" href="css/skins/default.css">

    <!-- Favicon icon -->
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" >

    <!-- Google fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Raleway:300,400,500,600,300,700">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Dosis%7CMontserrat:200,300,400,500,600,700,800,900%7CNunito+Sans:200,300,400,600,700,800,900">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link rel="stylesheet" type="text/css" href="css/ie10-viewport-bug-workaround.css">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script  src="js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script  src="js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script  src="js/html5shiv.min.js"></script>
    <script  src="js/respond.min.js"></script>
    <![endif]-->
</head>
<body bind-statement-1="if (#map.bounds && #map.center) refreshPlaces()" bind-statement-2="if (#map.apiReady) this.startup()">
<div class="page_loader"></div>

<!-- Main header start -->
<header class="main-header main-header-3 fixed-header2">
    <div class="container-fluid">
        <div bind-view="NavBar"
            bind-event-share-twitter="this.shareTwitter()"
            bind-event-share-facebook="this.shareFacebook()"
            bind-event-add-location="if (queryString.pass) #inputLocationDialog.visible = true; else #addLocationDialog.visible = true"></div>
    </div>
</header>
<!-- Main header end -->

<!-- Map content start -->
<div class="map-content content-area container-fluid">
    <div class="row no-gutters">
        <div class="col-12 d-lg-none p-3">
            <div bind-view="MapSearch"
                bind-param-api-ready="#map.apiReady"
                bind-param-bounds="#map.bounds"
                bind-param-progress="#progress"
                bind-event-place-changed="this.setCenterPlace(event.data)"
                bind-event-locate-me="this.locateMe()"></div>
        </div>
        <div class="col-lg-7">
            <div bind-view="TheMap"
                bind-param-api-ready="#map.apiReady"
                bind-param-center="#map.center"
                bind-param-places="#map.places"
                bind-statement-1="$(thisElem).css('height', #map.height)"
                bind-event-join-discussion="this.joinDiscussion(event.data)"
                bind-event-show-directions="this.showDirections(event.data)"
                bind-event-bounds-changed="#map.bounds = event.data"></div>
        </div>
        <div class="col-lg-5 map-content-sidebar p-2 p-lg-3">
            <div class="d-none d-lg-block mb-3">
                <div bind-view="MapSearch"
                    bind-param-api-ready="#map.apiReady"
                    bind-param-bounds="#map.bounds"
                    bind-param-progress="#progress"
                    bind-event-place-changed="this.setCenterPlace(event.data)"
                    bind-event-locate-me="this.locateMe()"></div>
            </div>
            <div bind-view="LocationDetails"
                bind-param-places="#map.places"
                bind-event-show-directions="this.showDirections(event.data)"
                bind-event-join-discussion="this.joinDiscussion(event.data)">
            </div>
        </div>
    </div>
</div>
<!-- Map content end -->

<!-- Footer -->
<div class="text-right">
    <a class="mt-1 mr-4" style="font-size: smaller" target="_blank" href="https://lsdsoftware.com/contact.html?subject=testingmap">contact us</a>
</div>

<!-- Dialogs -->
<div bind-view="AddLocationDialog" bind-param-visible="#addLocationDialog.visible"></div>
<div bind-view="DiscussionDialog" bind-param-visible="#discussionDialog.visible" bind-param-place="#discussionDialog.place"></div>
<div bind-view="InputLocationDialog" bind-param-visible="#inputLocationDialog.visible" bind-param-place="#inputLocationDialog.place"></div>

<script src="js/jquery-2.2.0.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script  src="js/bootstrap-submenu.js"></script>
<script  src="js/rangeslider.js"></script>
<script  src="js/bootstrap-select.min.js"></script>
<script  src="js/jquery.easing.1.3.js"></script>
<script  src="js/jquery.mCustomScrollbar.concat.min.js"></script>
<script  src="js/moment.min.js"></script>
<script  src="js/daterangepicker.min.js"></script>
<script  src="js/app.js"></script>

<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script  src="js/ie10-viewport-bug-workaround.js"></script>
<!-- Custom javascript -->
<script  src="js/ie10-viewport-bug-workaround.js"></script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-89110077-3', 'auto');
    ga('send', 'pageview');
</script>


<script src="https://assets.lsdsoftware.com/databind.js"></script>
<script src="js/components.js"></script>

<script>
    var queryString = {};
    if (location.search) {
        location.search.substr(1).split('&').forEach(function(token) {
            var pair = token.split('=');
            queryString[decodeURIComponent(pair[0])] = pair.length > 1 ? decodeURIComponent(pair[1]) : true;
        })
    }

    $("<div>").load("components.html", function() {
        $(this).children().each(function() {
            var className = $(this).data("class");
            dataBinder.views[className] = {template: this, controller: window[className]};
        })
    })

    map = {
        apiReady: false,
        bounds: null,
        places: null,
        height: null,
        center: null,
    };
    function onMapApiReady() {
        map.apiReady = true;
    }
    function setCenterPlace(place) {
        setCenter(place.geometry);
        if (queryString.pass) inputLocationDialog.place = place;
    }
    function setCenter(geometry) {
        map.center = geometry;
    }

    $(window).resize(onWindowResized).trigger("resize");
    function onWindowResized() {
        map.height = $(this).height() - 110;
    }

    function locateMe() {
        if (navigator.geolocation) {
            progress++;
            navigator.geolocation.getCurrentPosition(onLocateSuccess, onLocateFail);
        }
    }
    function onLocateSuccess(position) {
        progress--;
        setCenter({
            location: new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
        })
    }
    function onLocateFail(err) {
        progress--;
        console.error(err);
    }

    var serviceUrl = location.hostname == "localhost" ? "https://www.testingmap.com/webservices" : "/webservices";
    progress = 0;
    error = null;

    var refreshTimer = null;
    function refreshPlaces() {
        clearTimeout(refreshTimer);
        refreshTimer = setTimeout(refreshPlacesNow, 500);
    }
    function refreshPlacesNow() {
        progress++;
        $.ajax({
            url: serviceUrl + "/get-test-locations",
            data: {
                northEast: map.bounds.getNorthEast().toJSON(),
                southWest: map.bounds.getSouthWest().toJSON(),
                myLocation: map.center.location.toJSON()
            },
            dataType: "json",
            success: function(result) {
                map.places = result.sort(function(a,b) {return a.distance-b.distance});
            },
            error: function(xhr, textStatus, errorThrown) {
                error = {message: xhr.responseText || errorThrown || textStatus};
            },
            complete: function() {
                progress--;
            }
        })
    }

    addLocationDialog = {
        visible: false
    }

    discussionDialog = {
        place: null,
        visible: false
    }
    function joinDiscussion(place) {
        discussionDialog.place = place;
        discussionDialog.visible = true;
    }
    function showDirections(place) {
        window.open("https://www.google.com/maps/dir/?api=1&destination=" + place.lat + "," + place.lng, "_blank");
    }

    inputLocationDialog = {
        place: null,
        visible: false
    }

    function startup() {
        if (queryString.co) {
            var coords = queryString.co.split(",");
            setCenter({
                location: new google.maps.LatLng(coords[0], coords[1]),
                viewport: new google.maps.LatLngBounds(
                    new google.maps.LatLng(coords[2], coords[3]),
                    new google.maps.LatLng(coords[4], coords[5])
                )
            })
        }
        else locateMe();
    }

    function shareTwitter() {
        var url = "https://twitter.com/intent/tweet?url=" + encodeURIComponent(getUrlForSharing()) + "&text=" + encodeURIComponent("COVID-19 Testing Locations");
        window.open(url, "_blank");
    }
    function shareFacebook() {
        FB.ui({method: "share", href: getUrlForSharing()}, function() {});
    }
    function getUrlForSharing() {
        var base = location.href.split("?")[0];
        if (map.center) {
            var viewport = map.bounds.toJSON();
            var coords = [
                map.center.location.lat(),
                map.center.location.lng(),
                viewport.south,
                viewport.west,
                viewport.north,
                viewport.east
            ];
            return base + "?co=" + coords.join(",");
        }
        else return base;
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6bPXQ8LQBegMEIuXVNy04vgjYyQ6j1Lo&libraries=places&callback=onMapApiReady"></script>

<script>
    window.fbAsyncInit = function() {
        FB.init({
            appId            : '336240683089353',
            autoLogAppEvents : true,
            xfbml            : true,
            version          : 'v6.0'
        });
    };
</script>
<script async defer src="https://connect.facebook.net/en_US/sdk.js"></script>

</body>
</html>